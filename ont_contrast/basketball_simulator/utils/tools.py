from ontology.ont_sdk import OntologySdk
from ontology.account.account import Address, Account
from ontology.smart_contract.neo_contract.abi.abi_info import AbiInfo
from ontology.utils import util

import time
import json

# -------------------------------------------
# GLOBAL SETTINGS
# -------------------------------------------
rpc_addr = 'http://polaris3.ont.io:20336'
sdk = OntologySdk()
sdk.set_rpc(rpc_addr)
sdk.open_wallet('/Users/zou/PycharmProjects/ont_test/ont_contrast/demo/cli/wallet.json')

code = '011fc56b6a00527ac46a51527ac46a00c304696e697487640e006a51c300c3652b116c7566616a00c30a6e6578745f726f756e6487640e006a51c300c3655f0e6c7566616a00c30a6765745f73636f7265738764090065aa056c7566616a00c31472616e646f6d5f696e745f66726f6d5f7a65726f876414006a51c300c36a51c351c37c650f016c7566616a00c30573686f6f74876432006a51c300c36a51c351c36a51c352c36a51c353c35379517955727551727552795279547275527275654f0a516c7566616a00c309706173735f62616c6c87641b006a51c300c36a51c351c36a51c352c35272652e07516c7566616a00c3107069636b5f62616c6c5f686f6c646572876415006a51c300c36a51c351c37c654e03516c7566616a00c3096a756d705f62616c6c87640a0065fb01516c7566616a00c30b72616e645f706c6179657287640e006a51c300c36574006c7566616a00c30f6765745f7465616d5f73636f7265738764090065cc036c7566616a00c30d6765745f637572725f74696d65876409006533046c756661006c756658c56b6a00527ac46a51527ac46a51c36a52527ac46a52c36a53527ac46a53c36a00c3976a54527ac46a54c36c75660122c56b6a00527ac4054a616d65736a51527ac406447572616e746a52527ac40544617669736a53527ac40543757272796a54527ac40648617264656e6a55527ac4074c656f6e6172646a56527ac40d416e7465746f6b6f756e6d706f6a57527ac406456d626969646a58527ac40457616c6c6a59527ac4074f6c616469706f6a5a527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a5b527ac4556a5bc304736565647c681253797374656d2e53746f726167652e476574617c650bff6a5c527ac46a00c304776573749c6448006a5cc3009c6409006a51c36c7566616a5cc3519c6409006a52c36c7566616a5cc3529c6409006a53c36c7566616a5cc3539c6409006a54c36c7566616a55c36c7566624600616a5cc3009c6409006a56c36c7566616a5cc3519c6409006a57c36c7566616a5cc3529c6409006a58c36c7566616a5cc3539c6409006a59c36c7566616a5ac36c756661006c75665ec56b681953797374656d2e53746f726167652e476574436f6e74657874616a00527ac46a00c3086861735f62616c6c7c681253797374656d2e53746f726167652e47657461009e640700006c756661526a00c304736565647c681253797374656d2e53746f726167652e476574617c65fafd6a51527ac46a51c3519c64360004776573746a52527ac46a00c3086861735f62616c6c6a52c35272681253797374656d2e53746f726167652e507574616234006104656173746a52527ac46a00c3086861735f62616c6c6a52c35272681253797374656d2e53746f726167652e50757461611b4a554d502042414c4c21212047616d6520737461727420616e64206a52c30d20676574207468652062616c6c7e7e681553797374656d2e52756e74696d652e4e6f74696679616a52c3517c6509006a52c36c75665ac56b6a00527ac46a51527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a52527ac46a00c3652efd6a53527ac46a52c30b62616c6c5f686f6c6465726a53c35272681253797374656d2e53746f726167652e507574616a51c36440006a53c31d20686f6c64696e67207468652062616c6c20616e642070757368696e677e681553797374656d2e52756e74696d652e4e6f7469667961622e00616a53c30d20676574207468652062616c6c7e681553797374656d2e52756e74696d652e4e6f746966796161006c756656c56b681953797374656d2e53746f726167652e476574436f6e74657874616a00527ac46a00c30a776573745f73636f72657c681253797374656d2e53746f726167652e476574616a51527ac46a00c30a656173745f73636f72657c681253797374656d2e53746f726167652e476574616a52527ac46a51c36a52c352c176c96c756654c56b681953797374656d2e53746f726167652e476574436f6e74657874616a00527ac46a00c30474696d657c681253797374656d2e53746f726167652e476574616c75660113c56b054a616d65736a00527ac406447572616e746a51527ac40544617669736a52527ac40543757272796a53527ac40648617264656e6a54527ac4074c656f6e6172646a55527ac40d416e7465746f6b6f756e6d706f6a56527ac406456d626969646a57527ac40457616c6c6a58527ac4074f6c616469706f6a59527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a5a527ac46a5ac36a00c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a51c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a52c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a53c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a54c3065f73636f72657e7c681253797374656d2e53746f726167652e4765746155c176c96a5ac36a55c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a56c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a57c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a58c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5ac36a59c3065f73636f72657e7c681253797374656d2e53746f726167652e4765746155c176c952c176c96c7566012dc56b6a00527ac46a51527ac46a52527ac4054a616d65736a53527ac406447572616e746a54527ac40544617669736a55527ac40543757272796a56527ac40648617264656e6a57527ac4074c656f6e6172646a58527ac40d416e7465746f6b6f756e6d706f6a59527ac406456d626969646a5a527ac40457616c6c6a5b527ac4074f6c616469706f6a5c527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a5d527ac4556a5dc304736565647c681253797374656d2e53746f726167652e476574617c65abf86a5e527ac46a52c304776573749c645e006a5ec3009c640e006a53c36a5f527ac462a400616a5ec3519c640e006a54c36a5f527ac4629000616a5ec3529c640e006a55c36a5f527ac4627c00616a5ec3539c640e006a56c36a5f527ac4626800616a57c36a5f527ac4625c00616a5ec3009c640e006a58c36a5f527ac4624800616a5ec3519c640e006a59c36a5f527ac4623400616a5ec3529c640e006a5ac36a5f527ac4622000616a5ec3539c640e006a5bc36a5f527ac4620c00616a5cc36a5f527ac4616a5fc36a00c39c64fe00536a5dc304736565647c681253797374656d2e53746f726167652e476574617c65b8f76a60527ac46a60c3009c6443006a00c3202064726962626c6520616e64206f7267616e697a65207468652061747461636b7e681553797374656d2e52756e74696d652e4e6f7469667961628a00616a60c3519c643c006a00c3192046616e63792064726962626c65212053686f772054494d457e681553797374656d2e52756e74696d652e4e6f7469667961624800610b47726561742044206279206a51c37e1620616c6d6f7374206c6f7365207468652062616c6c206a00c37e7e681553797374656d2e52756e74696d652e4e6f746966796161625700616a00c309207061737320746f207e6a5fc37e681553797374656d2e52756e74696d652e4e6f74696679616a5dc30b62616c6c5f686f6c6465726a5fc35272681253797374656d2e53746f726167652e5075746161006c75660120c56b6a00527ac46a51527ac46a52527ac46a53527ac401646a54527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a55527ac46a55c36a00c30a5f6f66665f736b696c6c7e7c681253797374656d2e53746f726167652e476574616a56527ac46a55c36a51c30a5f6465665f736b696c6c7e7c681253797374656d2e53746f726167652e476574616a57527ac401506a55c304736565647c681253797374656d2e53746f726167652e476574617c65c9f56a58527ac4526a55c304736565647c681253797374656d2e53746f726167652e476574617c65a1f552936a59527ac401146a55c304736565647c681253797374656d2e53746f726167652e476574617c6576f50128936a5a527ac46a56c36a57c36a5ac3956a54c396946a5b527ac46a55c30474696d657c681253797374656d2e53746f726167652e476574616a5c527ac46a5bc36a58c3a264c4016a55c36a00c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5d527ac46a5dc36a59c3936a5d527ac46a55c36a00c3065f73636f72657e6a5dc35272681253797374656d2e53746f726167652e507574616a55c36a53c3065f73636f72657e7c681253797374656d2e53746f726167652e476574616a5e527ac46a5ec36a59c3936a5e527ac46a55c36a53c3065f73636f72657e6a5ec35272681253797374656d2e53746f726167652e507574616a52c353a06486006a59c3539c644e006a00c316206765742074686520332d706f696e742073686f74207e6a51c30f2063616e27742073746f702068696d7e7e681553797374656d2e52756e74696d652e4e6f7469667961622f00616a00c30e206d616b65207468652073686f747e681553797374656d2e52756e74696d652e4e6f746966796161627b00616a5cc35aa2643c00194f4d4721212120436f756e74646f776e2053686f74206279206a00c37e681553797374656d2e52756e74696d652e4e6f7469667961623900610e486520676f7420697421212121206a00c37e0827732073686f74217e681553797374656d2e52756e74696d652e4e6f746966796161627000616a5bc3013c9f643f006a00c30b2073686f6f7420616e64207e0b47726561742044206279206a51c37e7e681553797374656d2e52756e74696d652e4e6f7469667961622a00616a51c3092073746f702068696d7e681553797374656d2e52756e74696d652e4e6f746966796161006c75660124c56b6a00527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a51527ac46a51c304736565646a00c35272681253797374656d2e53746f726167652e507574616541f401186a52527ac46a51c3086861735f62616c6c7c681253797374656d2e53746f726167652e476574616a53527ac461616a52c300a064ac016a51c30b62616c6c5f686f6c6465727c681253797374656d2e53746f726167652e476574616a54527ac46a51c30474696d657c681253797374656d2e53746f726167652e476574616a55527ac4556a00c37c651ef254936a56527ac46a52c36a56c3946a52527ac46a52c3009f6416006a55c36a52c36a56c393946a55527ac4621000616a55c36a56c3946a55527ac4616a55c300a164470003656e64681553797374656d2e52756e74696d652e4e6f74696679616a51c3086861735f62616c6c7c681553797374656d2e53746f726167652e44656c6574656162d100616a51c30474696d656a55c35272681253797374656d2e53746f726167652e507574616a51c36a54c3045f6465667e7c681253797374656d2e53746f726167652e476574616a57527ac46a52c300a1642c006a54c36a57c36a52c36a53c35379517955727551727552795279547275527275659dfa62590062a2fe61526a00c37c6512f16a58527ac46a58c3009c642c006a54c36a57c36a52c36a53c35379517955727551727552795279547275527275655efa621a006263fe616a54c36a57c36a53c352726552f76251fe6161616a53c304776573749c64100004656173746a53527ac4620e006104776573746a53527ac4616a51c3086861735f62616c6c6a53c35272681253797374656d2e53746f726167652e50757461074e6f77206973206a53c37e681553797374656d2e52756e74696d652e4e6f74696679616a53c3007c6520f3006c7566014cc56b6a00527ac4054a616d65736a51527ac406447572616e746a52527ac40544617669736a53527ac40543757272796a54527ac40648617264656e6a55527ac4015f6a56527ac4015c6a57527ac401586a58527ac4015a6a59527ac4015a6a5a527ac401586a5b527ac401586a5c527ac4015a6a5d527ac4014e6a5e527ac401506a5f527ac4074c656f6e6172646a60527ac40d416e7465746f6b6f756e6d706f6a0111527ac406456d626969646a0112527ac40457616c6c6a0113527ac4074f6c616469706f6a0114527ac401616a0115527ac401586a0116527ac401586a0117527ac4015c6a0118527ac4015a6a0119527ac4015d6a011a527ac4015e6a011b527ac401596a011c527ac401586a011d527ac401586a011e527ac4681953797374656d2e53746f726167652e476574436f6e74657874616a011f527ac46a011fc304736565646a00c35272681253797374656d2e53746f726167652e507574616a011fc30474696d6502b4005272681253797374656d2e53746f726167652e507574616a011fc30a776573745f73636f7265005272681253797374656d2e53746f726167652e507574616a011fc30a656173745f73636f7265005272681253797374656d2e53746f726167652e507574616a011fc36a51c30a5f6f66665f736b696c6c7e6a56c35272681253797374656d2e53746f726167652e507574616a011fc36a52c30a5f6f66665f736b696c6c7e6a57c35272681253797374656d2e53746f726167652e507574616a011fc36a53c30a5f6f66665f736b696c6c7e6a58c35272681253797374656d2e53746f726167652e507574616a011fc36a54c30a5f6f66665f736b696c6c7e6a59c35272681253797374656d2e53746f726167652e507574616a011fc36a55c30a5f6f66665f736b696c6c7e6a5ac35272681253797374656d2e53746f726167652e507574616a011fc36a60c30a5f6f66665f736b696c6c7e6a0115c35272681253797374656d2e53746f726167652e507574616a011fc36a0111c30a5f6f66665f736b696c6c7e6a0116c35272681253797374656d2e53746f726167652e507574616a011fc36a0112c30a5f6f66665f736b696c6c7e6a0117c35272681253797374656d2e53746f726167652e507574616a011fc36a0113c30a5f6f66665f736b696c6c7e6a0118c35272681253797374656d2e53746f726167652e507574616a011fc36a0114c30a5f6f66665f736b696c6c7e6a0119c35272681253797374656d2e53746f726167652e507574616a011fc36a51c30a5f6465665f736b696c6c7e6a5bc35272681253797374656d2e53746f726167652e507574616a011fc36a52c30a5f6465665f736b696c6c7e6a5cc35272681253797374656d2e53746f726167652e507574616a011fc36a53c30a5f6465665f736b696c6c7e6a5dc35272681253797374656d2e53746f726167652e507574616a011fc36a54c30a5f6465665f736b696c6c7e6a5ec35272681253797374656d2e53746f726167652e507574616a011fc36a55c30a5f6465665f736b696c6c7e6a5fc35272681253797374656d2e53746f726167652e507574616a011fc36a60c30a5f6465665f736b696c6c7e6a011ac35272681253797374656d2e53746f726167652e507574616a011fc36a0111c30a5f6465665f736b696c6c7e6a011bc35272681253797374656d2e53746f726167652e507574616a011fc36a0112c30a5f6465665f736b696c6c7e6a011cc35272681253797374656d2e53746f726167652e507574616a011fc36a0113c30a5f6465665f736b696c6c7e6a011dc35272681253797374656d2e53746f726167652e507574616a011fc36a0114c30a5f6465665f736b696c6c7e6a011ec35272681253797374656d2e53746f726167652e507574616a011fc36a51c3045f6465667e6a60c35272681253797374656d2e53746f726167652e507574616a011fc36a52c3045f6465667e6a0111c35272681253797374656d2e53746f726167652e507574616a011fc36a53c3045f6465667e6a0112c35272681253797374656d2e53746f726167652e507574616a011fc36a54c3045f6465667e6a0113c35272681253797374656d2e53746f726167652e507574616a011fc36a55c3045f6465667e6a0114c35272681253797374656d2e53746f726167652e507574616a011fc36a60c3045f6465667e6a51c35272681253797374656d2e53746f726167652e507574616a011fc36a0111c3045f6465667e6a52c35272681253797374656d2e53746f726167652e507574616a011fc36a0112c3045f6465667e6a53c35272681253797374656d2e53746f726167652e507574616a011fc36a0113c3045f6465667e6a54c35272681253797374656d2e53746f726167652e507574616a011fc36a0114c3045f6465667e6a55c35272681253797374656d2e53746f726167652e507574616a011fc36a51c3065f73636f72657e005272681253797374656d2e53746f726167652e507574616a011fc36a52c3065f73636f72657e005272681253797374656d2e53746f726167652e507574616a011fc36a53c3065f73636f72657e005272681253797374656d2e53746f726167652e507574616a011fc36a54c3065f73636f72657e005272681253797374656d2e53746f726167652e507574616a011fc36a55c3065f73636f72657e005272681253797374656d2e53746f726167652e507574616a011fc3086861735f62616c6c005272681253797374656d2e53746f726167652e507574610a67616d65207374617274681553797374656d2e52756e74696d652e4e6f7469667961516c75665ec56b6a00527ac46a51527ac46a51c36a00c3946a52527ac46a52c3c56a53527ac4006a54527ac46a00c36a55527ac461616a00c36a51c39f6433006a54c36a55c3936a56527ac46a56c36a53c36a54c37bc46a54c351936a54527ac46a55c36a54c3936a00527ac462c8ff6161616a53c36c7566'
addr = Address.address_from_vm_code(code)
contract_addr = addr.to_array()

abi = '{"functions":[{"name":"main","parameters":[{"name":"op","type":""},{"name":"args","type":""}],"returntype":""},{"name":"init","parameters":[{"name":"seed","type":""}],"returntype":""},{"name":"next_round","parameters":[{"name":"seed","type":""}],"returntype":""},{"name":"shoot","parameters":[{"name":"off_player","type":""},{"name":"def_player","type":""},{"name":"seconds","type":""},{"name":"team","type":""}],"returntype":""},{"name":"pass_ball","parameters":[{"name":"holder","type":""},{"name":"def_player","type":""},{"name":"team","type":""}],"returntype":""},{"name":"get_scores","parameters":[{"name":"","type":""}],"returntype":""},{"name":"get_curr_time","parameters":[{"name":"","type":""}],"returntype":""},{"name":"get_team_scores","parameters":[{"name":"","type":""}],"returntype":""},{"name":"pick_ball_holder","parameters":[{"name":"team","type":""},{"name":"is_first","type":""}],"returntype":""},{"name":"jump_ball","parameters":[{"name":"","type":""}],"returntype":""},{"name":"rand_player","parameters":[{"name":"team","type":""}],"returntype":""},{"name":"random_int_from_zero","parameters":[{"name":"num","type":""},{"name":"seed","type":""}],"returntype":""}]}'
abi = json.loads(abi)
abi_info = AbiInfo('0x' + addr.to_reverse_hex_str(), 'main', abi['functions'], [])

acc1 = sdk.get_wallet_manager().get_account('ANH5bHrrt111XwNEnuPZj6u95Dd6u7G4D6', '1')


def get_from_hex(res):
    """
    hex to string
    :param res:
    :return:
    """
    return util.parse_neo_vm_contract_return_type_string(res)


def get_integer_from_hex(res):
    """
    hex to integer
    :param res:
    :return:
    """
    return util.parse_neo_vm_contract_return_type_integer(res)


def print_info(res):
    """
    print notify info
    :param res: json
    :return:
    """
    now = time.time()
    json_res = sdk.get_rpc().get_smart_contract_event_by_tx_hash(res)
    while json_res is None:
        json_res = sdk.get_rpc().get_smart_contract_event_by_tx_hash(res)
        time.sleep(0.1)
    print('checking tx cost %.2fs' % (time.time() - now))
    print(json_res)
    print('txid: %s' % res)
    # try:
    #     print('action:%s\nfrom_account:%s\nto_account:%s\namount:%s'
    #           % (get_from_hex(json_res['Notify'][0]['States'][0]),
    #              json_res['Notify'][0]['States'][1], json_res['Notify'][0]['States'][2],
    #              util.parse_neo_vm_contract_return_type_integer(json_res['Notify'][0]['States'][3])))
    # except Exception:
    #     print('wrong notify')


def get_states_list(txid, addr):
    """
    Put the events of addr in a list and return
    :param txid:
    :param addr:
    :return:
    """
    json_res = sdk.get_rpc().get_smart_contract_event_by_tx_hash(txid)
    while json_res is None:
        json_res = sdk.get_rpc().get_smart_contract_event_by_tx_hash(txid)
        time.sleep(0.1)
    notifies = json_res['Notify']
    states = []
    for i in range(len(notifies)):
        if notifies[i]['ContractAddress'] == addr:
            # print(notifies[i]['ContractAddress'])
            # print(get_from_hex(notifies[i]['States']))
            states.append(get_from_hex(notifies[i]['States']))
    return states